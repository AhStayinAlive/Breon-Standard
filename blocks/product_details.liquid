{% comment %}
  Broen Product Page - Apple-Inspired Hero Section
  Monochrome design system with enhanced carousel navigation
  Enhanced with real variant selection and variant-first media
  UPDATED: Removed specifications buttons, added liquid glass Add to Cart and Messages blue Buy Now
{% endcomment %}

{% assign section_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .broen-hero-{{ section_id }} {
    --page-bg: {% if block.settings.page_background != blank %}{{ block.settings.page_background }}{% else %}#000000{% endif %};
    --card-bg: {% if block.settings.card_background != blank %}{{ block.settings.card_background }}{% else %}#111111{% endif %};
    --media-bg: {% if block.settings.media_background != blank %}{{ block.settings.media_background }}{% else %}#1a1a1a{% endif %};
    --text: {% if block.settings.text_color != blank %}{{ block.settings.text_color }}{% else %}#ffffff{% endif %};
    --muted: {% if block.settings.muted_text_color != blank %}{{ block.settings.muted_text_color }}{% else %}#999999{% endif %};
    --border: {% if block.settings.border_color != blank %}{{ block.settings.border_color }}{% else %}rgba(255, 255, 255, 0.1){% endif %};
    --chip-bg: {% if block.settings.chip_background != blank %}{{ block.settings.chip_background }}{% else %}#222222{% endif %};
    --chip-text: {% if block.settings.chip_text_color != blank %}{{ block.settings.chip_text_color }}{% else %}#ffffff{% endif %};
    --focus: {% if block.settings.focus_color != blank %}{{ block.settings.focus_color }}{% else %}#ffffff{% endif %};
    --dot-active: {% if block.settings.dot_active_color != blank %}{{ block.settings.dot_active_color }}{% else %}#ffffff{% endif %};
    --dot-inactive: {% if block.settings.dot_inactive_color != blank %}{{ block.settings.dot_inactive_color }}{% else %}rgba(255, 255, 255, 0.3){% endif %};
    --cta-bg: {% if block.settings.cta_background != blank %}{{ block.settings.cta_background }}{% else %}#ffffff{% endif %};
    --cta-text: {% if block.settings.cta_text_color != blank %}{{ block.settings.cta_text_color }}{% else %}#000000{% endif %};
    --cta-hover: {% if block.settings.cta_hover_background != blank %}{{ block.settings.cta_hover_background }}{% else %}#f0f0f0{% endif %};
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.12);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.16);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.24);
    --blur: 20px;
    --radius: {% if block.settings.border_radius != blank %}{{ block.settings.border_radius }}px{% else %}20px{% endif %};
    
    /* Apple liquid glass tokens */
    --lg-blur: 18px;
    --lg-saturate: 180%;
    --lg-border: hsla(0,0%,100%,.22);
    --lg-shadow: rgba(0,0,0,.25);
    --messages-blue: #007AFF;
    /* New scoped variables */
    --mortise-bg: {% if block.settings.mortise_chip_background != blank %}{{ block.settings.mortise_chip_background }}{% else %}var(--chip-bg){% endif %};
    --mortise-text: {% if block.settings.mortise_chip_text_color != blank %}{{ block.settings.mortise_chip_text_color }}{% else %}var(--chip-text){% endif %};
    --buy-now-bg: {% if block.settings.buy_now_background != blank %}{{ block.settings.buy_now_background }}{% else %}#007AFF{% endif %};
    --buy-now-text: {% if block.settings.buy_now_text_color != blank %}{{ block.settings.buy_now_text_color }}{% else %}#ffffff{% endif %};
    --buy-now-hover: {% if block.settings.buy_now_hover_background != blank %}{{ block.settings.buy_now_hover_background }}{% else %}#0056CC{% endif %};
  }

  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  .broen-hero-{{ section_id }} {
    background: var(--page-bg);
    color: var(--text);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    letter-spacing: -0.01em;
    line-height: 1.5;
    font-synthesis: none;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow: visible;
  }
  
  /* Ensure parent sections allow overflow for hover expansion */
  .shopify-section:has(.broen-hero-{{ section_id }}) {
    overflow: visible;
  }

  .broen-hero__container-{{ section_id }} {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  .broen-hero__grid-{{ section_id }} {
    display: grid;
    grid-template-columns: 1fr;
    gap: 40px;
    align-items: start;
  }

  /* Media Carousel */
  .broen-hero__media-{{ section_id }} {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    position: relative;
    z-index: 3;
    isolation: isolate;
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow-md);
  }

  .broen-hero__carousel-wrapper-{{ section_id }} {
    position: relative;
    overflow: hidden;
    border-radius: var(--radius);
  }

  .broen-hero__carousel-{{ section_id }} {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-behavior: smooth;
  }

  .broen-hero__carousel-{{ section_id }}::-webkit-scrollbar {
    display: none;
  }

  .broen-hero__media-item-{{ section_id }} {
    flex: 0 0 100%;
    scroll-snap-align: start;
    aspect-ratio: 1;
    position: relative;
    background: var(--media-bg);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .broen-hero__media-content-{{ section_id }} {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .broen-hero__media-item-{{ section_id }}:hover img.broen-hero__media-content-{{ section_id }} {
    transform: scale(1.02);
  }

  /* Optimize video placement and disable hover interaction */
  .broen-hero__media-{{ section_id }} video.broen-hero__media-content-{{ section_id }} {
    object-fit: cover;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  

  .broen-hero__placeholder-{{ section_id }} {
    font-size: 64px;
    color: var(--muted);
    font-weight: 300;
    opacity: 0.5;
  }

  /* Carousel Navigation */
  .broen-hero__nav-btn-{{ section_id }} {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    background: rgba(34, 34, 34, 0.9);
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 50;
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow-sm);
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    opacity: 1;
    pointer-events: auto;
  }

  .broen-hero__nav-btn-{{ section_id }}:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-50%) scale(1.05);
    box-shadow: var(--shadow-md);
  }

  .broen-hero__nav-btn-{{ section_id }}:focus {
    outline: 2px solid var(--focus);
    outline-offset: 2px;
  }

  .broen-hero__nav-btn-{{ section_id }}--prev {
    left: 20px;
  }

  .broen-hero__nav-btn-{{ section_id }}--next {
    right: 20px;
  }

  .broen-hero__nav-btn-{{ section_id }} svg {
    color: var(--text);
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .broen-hero__nav-btn-{{ section_id }}:hover svg {
    opacity: 1;
  }

  .broen-hero__dots-{{ section_id }} {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 20px;
    background: var(--card-bg);
  }

  .broen-hero__dot-{{ section_id }} {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 1;
  }

  .broen-hero__dot-{{ section_id }}:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  .broen-hero__dot-{{ section_id }}:focus {
    outline: 2px solid var(--focus);
    outline-offset: 4px;
  }

  .broen-hero__dot-{{ section_id }}.active {
    background: #ffffff;
    transform: none;
    opacity: 1;
  }

  /* Product Info */
  .broen-hero__info-{{ section_id }} {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px;
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow-md);
  }

  /* Title and Classification - Plain Text */
  .broen-hero__title-{{ section_id }} {
    color: var(--text);
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 12px 0;
    letter-spacing: -0.02em;
    line-height: 1.2;
  }

  .broen-hero__classification-{{ section_id }} {
    font-size: 11px;
    font-weight: 600;
    color: {% if block.settings.classification_text_color != blank %}{{ block.settings.classification_text_color }}{% else %}#deb887{% endif %};
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 6px 12px;
    background: {% if block.settings.classification_background != blank %}{{ block.settings.classification_background }}{% else %}rgba(97,69,36,.4){% endif %};
    border: 1px solid {% if block.settings.classification_border != blank %}{{ block.settings.classification_border }}{% else %}rgba(97,69,36,.6){% endif %};
    border-radius: 16px;
    display: inline-block;
    width: fit-content;
    backdrop-filter: blur(10px);
    margin: 0 0 20px 0;
  }

  .broen-hero__price-{{ section_id }} {
    font-size: 36px;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 24px 0;
    letter-spacing: -0.02em;
  }

  /* Sections */
  .broen-hero__section-{{ section_id }} {
    margin: 24px 0;
  }

  .broen-hero__section-label-{{ section_id }} {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 12px;
    display: block;
  }

  /* Color Swatches */
  .broen-hero__colors-{{ section_id }} {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    role: radiogroup;
  }

  .broen-hero__color-{{ section_id }} {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    position: relative;
    background: var(--chip-bg);
    box-shadow: var(--shadow-sm);
    role: radio;
    flex-shrink: 0; /* Prevent squashing */
  }

  .broen-hero__color-{{ section_id }}:hover:not([aria-disabled="true"]):not(:disabled) {
    transform: scale(1.08);
    box-shadow: var(--shadow-md);
  }

  .broen-hero__color-{{ section_id }}:focus {
    outline: 2px solid var(--focus);
    outline-offset: 4px;
  }

  .broen-hero__color-{{ section_id }}.selected {
    border-color: var(--text);
    transform: scale(1.12);
    box-shadow: var(--shadow-lg);
    aria-checked: true;
  }

  .broen-hero__color-{{ section_id }}.selected::after {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: 50%;
    border: 2px solid var(--text);
    opacity: 0.6;
  }

  .broen-hero__color-{{ section_id }}:disabled,
  .broen-hero__color-{{ section_id }}[aria-disabled="true"] {
    opacity: 0.4;
    cursor: not-allowed;
    filter: grayscale(0.5);
    pointer-events: none;
  }

  /* Mortise Types */
  .broen-hero__mortise-grid-{{ section_id }} {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 24px;
    role: radiogroup;
  }

  .broen-hero__mortise-{{ section_id }} {
    background: var(--mortise-bg);
    color: var(--mortise-text);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    cursor: pointer;
    text-align: center;
    min-width: 80px;
    box-shadow: var(--shadow-sm);
    role: radio;
  }

  /* Square variant with image styling */
  .broen-hero__mortise-{{ section_id }}.has-image {
    border-radius: 12px;
    width: 72px;
    height: 72px;
    padding: 4px;
    min-width: 72px;
  }

  .broen-hero__mortise-{{ section_id }}:hover:not([aria-disabled="true"]):not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--text);
  }

  .broen-hero__mortise-{{ section_id }}.selected {
    border-color: var(--text);
    background: var(--text);
    color: var(--page-bg);
    aria-checked: true;
  }

  .broen-hero__mortise-{{ section_id }}.has-image.selected {
    background: var(--chip-bg);
    color: var(--text);
    border-color: var(--text);
    border-width: 2px;
  }

  .broen-hero__mortise-{{ section_id }}:disabled,
  .broen-hero__mortise-{{ section_id }}[aria-disabled="true"] {
    opacity: 0.4;
    cursor: not-allowed;
    filter: grayscale(0.5);
    pointer-events: none;
  }

  /* Button Container */
  .broen-hero__buttons-{{ section_id }} {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 20px 0 0 0;
  }

  /* Liquid Glass Add to Cart Button */
  .broen-hero__add-to-cart-{{ section_id }} {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif !important;
    font-weight: 600;
    letter-spacing: -0.01em;
    font-size: 16px !important;
    line-height: 1;
    color: #ffffff !important;

    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    cursor: pointer;
    white-space: nowrap;
    min-height: 48px;
    padding: 16px 32px !important;
    border-radius: 100px !important;
    border: 1px solid var(--lg-border) !important;

    /* Pure liquid glass */
    background: linear-gradient(0deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.18)) !important;
    backdrop-filter: saturate(var(--lg-saturate)) blur(var(--lg-blur)) !important;
    -webkit-backdrop-filter: saturate(var(--lg-saturate)) blur(var(--lg-blur)) !important;
    box-shadow: 0 6px 18px var(--lg-shadow), inset 0 1px 0 rgba(255,255,255,.12) !important;

    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
  }

  .broen-hero__add-to-cart-{{ section_id }}:hover:not(:disabled) {
    transform: translateY(-1px);
    background: linear-gradient(0deg, rgba(255, 255, 255, 0.24), rgba(255, 255, 255, 0.24)) !important;
    box-shadow: 0 10px 24px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.14) !important;
  }

  .broen-hero__add-to-cart-{{ section_id }}:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.10) !important;
  }

  .broen-hero__add-to-cart-{{ section_id }}:focus {
    outline: 3px solid rgba(255, 255, 255, 0.5);
    outline-offset: 2px;
  }

  .broen-hero__add-to-cart-{{ section_id }}:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Messages Blue Buy Now Button */
  .broen-hero__buy-now-{{ section_id }} {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif;
    font-weight: 600;
    letter-spacing: -0.01em;
    font-size: 16px;
    line-height: 1;
    color: var(--buy-now-text);

    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    cursor: pointer;
    white-space: nowrap;
    min-height: 48px;
    padding: 16px 32px;
    border-radius: 100px;
    border: none;

    background: var(--buy-now-bg);
    box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);

    transition: all 0.2s ease;
  }

  .broen-hero__buy-now-{{ section_id }}:hover:not(:disabled) {
    background: var(--buy-now-hover);
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(0, 122, 255, 0.4);
  }

  .broen-hero__buy-now-{{ section_id }}:active {
    transform: translateY(0);
    background: #004999;
  }

  .broen-hero__buy-now-{{ section_id }}:focus {
    outline: 3px solid rgba(0, 122, 255, 0.5);
    outline-offset: 2px;
  }

  .broen-hero__buy-now-{{ section_id }}:disabled {
    background: var(--chip-bg);
    color: var(--muted);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Desktop Layout */
  @media (min-width: 768px) {
    .broen-hero__container-{{ section_id }} {
      padding: 60px 40px;
    }

    .broen-hero__grid-{{ section_id }} {
      grid-template-columns: 1fr 1fr;
      gap: 60px;
    }
  }

  /* Mobile Layout */
  @media (max-width: 767px) {
    .broen-hero__buttons-{{ section_id }} {
      grid-template-columns: 1fr;
      gap: 12px;
    }
  }

  /* Single slide state */
  .broen-hero__carousel-wrapper-{{ section_id }}.single-slide .broen-hero__nav-btn-{{ section_id }} {
    display: none;
  }
{% endstyle %}

<section class="broen-hero-{{ section_id }}" {{ section.shopify_attributes }}>
  <div class="broen-hero__container-{{ section_id }}">
    <div class="broen-hero__grid-{{ section_id }}">
      
      <!-- Media Carousel -->
      <div class="broen-hero__media-{{ section_id }}">
        <div class="broen-hero__carousel-wrapper-{{ section_id }}" id="carousel-wrapper-{{ section_id }}">
          <div class="broen-hero__carousel-{{ section_id }}" id="carousel-{{ section_id }}">
            <!-- Media items will be dynamically populated by JavaScript -->
          </div>

          <!-- Navigation Arrows -->
          <button 
            class="broen-hero__nav-btn-{{ section_id }} broen-hero__nav-btn-{{ section_id }}--prev" 
            id="prev-{{ section_id }}"
            aria-label="Previous image"
          >
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button 
            class="broen-hero__nav-btn-{{ section_id }} broen-hero__nav-btn-{{ section_id }}--next" 
            id="next-{{ section_id }}"
            aria-label="Next image"
          >
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <!-- Carousel Dots -->
        <div class="broen-hero__dots-{{ section_id }}" id="dots-{{ section_id }}"></div>
      </div>

      <!-- Product Info -->
      <div class="broen-hero__info-{{ section_id }}">
        
        <!-- Header -->
        <div>
          <h1 class="broen-hero__title-{{ section_id }}">
            {{ product.title | default: "Product name" }}
          </h1>
          
          {% assign door_type = product.metafields.custom.door_type.value | default: product.metafields.custom.door_type %}
          {% if door_type != blank %}
            <span class="broen-hero__classification-{{ section_id }}">
              {{ door_type | replace: '-', ' ' | capitalize }}
            </span>
          {% else %}
            <span class="broen-hero__classification-{{ section_id }}">Door Classification</span>
          {% endif %}
        </div>

        <!-- Price -->
        <div class="broen-hero__price-{{ section_id }}" id="price-{{ section_id }}">
          {{ product.selected_or_first_available_variant.price | money | default: "Price" }}
        </div>

        <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form-{{ section_id }}">
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" id="variant-id-{{ section_id }}">

          <!-- Color Section -->
          {% comment %} FIXED: Robust color option detection {% endcomment %}
          {%- assign color_option_index = nil -%}
          {%- for option in product.options_with_values -%}
            {%- assign name_lc = option.name | downcase -%}
            {%- if name_lc contains 'color' or name_lc contains 'colour' -%}
              {%- assign color_option_index = forloop.index0 -%}{%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {% comment %} FIXED: Proper array building from metafields {% endcomment %}
          {%- assign color_values = '' | split: '' -%}
          {%- if color_option_index != nil -%}
            {%- assign color_values = product.options_with_values[color_option_index].values -%}
          {%- elsif product.metafields.custom.color_swatches and product.metafields.custom.color_swatches.value -%}
            {%- for c in product.metafields.custom.color_swatches.value -%}
              {%- assign color_values = color_values | push: c.name | default: c -%}
            {%- endfor -%}
          {%- endif -%}

          {% if color_values.size > 0 %}
          <div class="broen-hero__section-{{ section_id }}">
            <label class="broen-hero__section-label-{{ section_id }}">Color</label>
            <div class="broen-hero__colors-{{ section_id }}" role="radiogroup" aria-label="Color options">
              {% for color_value in color_values %}
                {% comment %} Find matching metafield color for styling {% endcomment %}
                {% assign meta_color = null %}
                {% assign color_style = 'background-color: ' %}
                {% assign has_color = false %}
                
                {% if product.metafields.custom.color_swatches.value.size > 0 %}
                  {% for meta in product.metafields.custom.color_swatches.value %}
                    {% assign meta_name = meta.name | default: meta %}
                    {% if meta_name == color_value %}
                      {% assign meta_color = meta %}
                      {% if meta.hex %}
                        {% assign color_style = color_style | append: meta.hex | append: ';' %}
                        {% assign has_color = true %}
                      {% endif %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                {% endif %}

                {% comment %} Fallback color mapping for common color names {% endcomment %}
                {% unless has_color %}
                  {% assign color_lower = color_value | downcase %}
                  {% case color_lower %}
                    {% when 'black' %}
                      {% assign color_style = color_style | append: '#000000;' %}
                      {% assign has_color = true %}
                    {% when 'white' %}
                      {% assign color_style = color_style | append: '#ffffff;' %}
                      {% assign has_color = true %}
                    {% when 'brown' %}
                      {% assign color_style = color_style | append: '#8B4513;' %}
                      {% assign has_color = true %}
                    {% when 'gray' or 'grey' %}
                      {% assign color_style = color_style | append: '#808080;' %}
                      {% assign has_color = true %}
                    {% when 'bronze' %}
                      {% assign color_style = color_style | append: '#CD7F32;' %}
                      {% assign has_color = true %}
                    {% when 'silver' %}
                      {% assign color_style = color_style | append: '#C0C0C0;' %}
                      {% assign has_color = true %}
                    {% when 'gold' %}
                      {% assign color_style = color_style | append: '#FFD700;' %}
                      {% assign has_color = true %}
                    {% else %}
                      {% assign color_style = color_style | append: '#666666;' %}
                      {% assign has_color = true %}
                  {% endcase %}
                {% endunless %}

                <button
                  type="button"
                  class="broen-hero__color-{{ section_id }}{% if color_option_index != nil and color_value == product.selected_or_first_available_variant.options[color_option_index] %} selected{% endif %}"
                  data-color-value="{{ color_value }}"
                  aria-label="Color: {{ color_value }}"
                  role="radio"
                  tabindex="0"
                  style="{{ color_style }}"
                >
                  {% if meta_color.image %}
                    <img src="{{ meta_color.image | image_url: width: 48 }}" alt="{{ color_value }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Mortise Section -->
          {% comment %} FIXED: Robust mortise option detection {% endcomment %}
          {%- assign mortise_option_index = nil -%}
          {%- for option in product.options_with_values -%}
            {%- assign name_lc = option.name | downcase -%}
            {%- if name_lc contains 'mortise' or name_lc contains 'lock case' or name_lc contains 'locking' -%}
              {%- assign mortise_option_index = forloop.index0 -%}{%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {% comment %} FIXED: Proper array building from metafields {% endcomment %}
          {%- assign mortise_values = '' | split: '' -%}
          {%- if mortise_option_index != nil -%}
            {%- assign mortise_values = product.options_with_values[mortise_option_index].values -%}
          {%- elsif product.metafields.custom.mortise_types and product.metafields.custom.mortise_types.value -%}
            {%- for m in product.metafields.custom.mortise_types.value -%}
              {%- assign mortise_values = mortise_values | push: m.name | default: m -%}
            {%- endfor -%}
          {%- endif -%}

          {% if mortise_values.size > 0 %}
          <div class="broen-hero__section-{{ section_id }}">
            <label class="broen-hero__section-label-{{ section_id }}">Mortise (Lock Case)</label>
            <div class="broen-hero__mortise-grid-{{ section_id }}" role="radiogroup" aria-label="Mortise type options">
              {% for mortise_value in mortise_values %}
                {% comment %} Find variant with this mortise to get its image {% endcomment %}
                {% assign variant_image = null %}
                {% if mortise_option_index != null %}
                  {% for variant in product.variants %}
                    {% if variant.options[mortise_option_index] == mortise_value and variant.featured_media %}
                      {% assign variant_image = variant.featured_media %}
                      {% break %}
                    {% endif %}
                  {% endfor %}
                {% endif %}

                <button
                  type="button"
                  class="broen-hero__mortise-{{ section_id }}{% if variant_image %} has-image{% endif %}{% if mortise_option_index != nil and mortise_value == product.selected_or_first_available_variant.options[mortise_option_index] %} selected{% endif %}"
                  data-mortise-value="{{ mortise_value }}"
                  aria-label="Mortise: {{ mortise_value }}"
                  role="radio"
                  tabindex="0"
                >
                  {% if variant_image %}
                    <img src="{{ variant_image | image_url: width: 72 }}" alt="{{ mortise_value }}" style="width: 100%; height: 60%; object-fit: cover; border-radius: 8px; margin-bottom: 2px;">
                    <span style="display: block; width: 100%; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ mortise_value }}</span>
                  {% else %}
                    {{ mortise_value }}
                  {% endif %}
                </button>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Action Buttons -->
          <div class="broen-hero__buttons-{{ section_id }}">
            <button
              type="submit"
              class="broen-hero__add-to-cart-{{ section_id }}"
              id="add-to-cart-{{ section_id }}"
              {% unless product.available %}disabled{% endunless %}
            >
              {% if product.available %}
                Add to Cart
              {% else %}
                Sold Out
              {% endif %}
            </button>

            <button
              type="button"
              class="broen-hero__buy-now-{{ section_id }}"
              id="buy-now-{{ section_id }}"
              {% unless product.available %}disabled{% endunless %}
            >
              {% if product.available %}
                Buy Now
              {% else %}
                Sold Out
              {% endif %}
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</section>

<script>
(function() {
  const sectionId = '{{ section_id }}';
  const section = document.querySelector('.broen-hero-' + sectionId);
  
  // Product data
  const variants = {{ product.variants | json }};
  const colorOptionIndex = {{ color_option_index | json }};
  const mortiseOptionIndex = {{ mortise_option_index | json }};
  const colorValues = {{ color_values | json }};
  
  // Media mapping
  const heroVideoUrl = {{ product.metafields.custom.hero_video.value | default: product.metafields.custom.hero_video | json }};
  const productMedia = [
    {% for media in product.media limit: 8 %}
      {% assign skip_image = false %}
      {% assign alt_text = media.alt | downcase %}
      {% if alt_text contains 'feature' or alt_text contains 'spec' or alt_text contains 'unlock' or alt_text contains 'way' or alt_text contains 'method' %}
        {% assign skip_image = true %}
      {% endif %}
      {% unless skip_image %}
      {
        id: {{ media.id | json }},
        type: {{ media.media_type | json }},
        src: {{ media | image_url: width: 1200 | json }},
        alt: {{ media.alt | default: product.title | escape | json }},
        {% if media.media_type == 'video' %}
        videoSrc: {{ media.sources[0].url | json }},
        mimeType: {{ media.sources[0].mime_type | json }},
        poster: {% if media.preview_image %}{{ media.preview_image | image_url: width: 800 | json }}{% else %}null{% endif %},
        {% endif %}
      },
      {% endunless %}
    {% endfor %}
  ];

  // DOM elements
  const carousel = document.getElementById(`carousel-${sectionId}`);
  const carouselWrapper = document.getElementById(`carousel-wrapper-${sectionId}`);
  const dotsContainer = document.getElementById(`dots-${sectionId}`);
  const prevBtn = document.getElementById(`prev-${sectionId}`);
  const nextBtn = document.getElementById(`next-${sectionId}`);
  const variantIdInput = document.getElementById(`variant-id-${sectionId}`);
  const priceElement = document.getElementById(`price-${sectionId}`);
  const addToCartButton = document.getElementById(`add-to-cart-${sectionId}`);
  const buyNowButton = document.getElementById(`buy-now-${sectionId}`);

  // State
  let currentSlide = 0;
  let totalSlides = 0;
  let currentVariant = {{ product.selected_or_first_available_variant | json }};
  let selectedColor = null;
  let selectedMortise = null;

  // Initialize selected values from current variant
  if (currentVariant && variants.length > 0) {
    if (colorOptionIndex !== null && currentVariant.options[colorOptionIndex]) {
      selectedColor = currentVariant.options[colorOptionIndex];
    }
    if (mortiseOptionIndex !== null && currentVariant.options[mortiseOptionIndex]) {
      selectedMortise = currentVariant.options[mortiseOptionIndex];
    }
  }

  // Initialize on page load - also check URL params
  function initializeFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const variantId = urlParams.get('variant');
    
    if (variantId) {
      const variant = variants.find(v => v.id == variantId);
      if (variant) {
        currentVariant = variant;
        if (colorOptionIndex !== null && variant.options[colorOptionIndex]) {
          selectedColor = variant.options[colorOptionIndex];
        }
        if (mortiseOptionIndex !== null && variant.options[mortiseOptionIndex]) {
          selectedMortise = variant.options[mortiseOptionIndex];
        }
      }
    }
  }

  function createMediaSlide(media) {
    const slide = document.createElement('div');
    slide.className = `broen-hero__media-item-${sectionId}`;
    slide.dataset.mediaId = media.id;

    if (media.type === 'video') {
      const video = document.createElement('video');
      video.className = `broen-hero__media-content-${sectionId}`;
      video.muted = true;
      video.loop = true;
      video.playsInline = true;
      video.setAttribute('playsinline', '');
      video.autoplay = true;
      video.setAttribute('autoplay', '');
      video.preload = 'metadata';
      if (media.poster) video.poster = media.poster;
      
      const source = document.createElement('source');
      source.src = media.videoSrc;
      source.type = media.mimeType;
      video.appendChild(source);
      
      slide.appendChild(video);
    } else {
      const img = document.createElement('img');
      img.className = `broen-hero__media-content-${sectionId}`;
      img.src = media.src;
      img.alt = media.alt;
      img.loading = 'lazy';
      slide.appendChild(img);
    }

    return slide;
  }

  function shouldIncludeMedia(media) {
    // Only include images here; videos are handled via heroVideoUrl
    if (media.type === 'video') return false;
    // Skip duplicate of current variant featured image
    if (currentVariant && currentVariant.featured_media && media.id === currentVariant.featured_media.id) return false;

    const alt = (media.alt || '').toLowerCase();
    const sel = (selectedColor || '').toLowerCase();

    // If we have color values, exclude media that clearly references other colors
    if (Array.isArray(colorValues) && colorValues.length > 0) {
      const mentionsAnyColor = colorValues.some(cv => alt.includes(String(cv).toLowerCase()));
      if (mentionsAnyColor) {
        // Include only if it mentions the selected color
        return sel ? alt.includes(sel) : false;
      }
    }

    // Media without color mentions is considered generic and included
    return true;
  }

  function rebuildCarousel() {
    if (!carousel) return;

    // Clear existing slides
    carousel.innerHTML = '';

    const slides = [];
    const usedMediaIds = new Set();

    // 1. Add variant's featured media first (if exists)
    if (currentVariant && currentVariant.featured_media && currentVariant.featured_media.id) {
      const featuredMedia = productMedia.find(m => m.id === currentVariant.featured_media.id);
      if (featuredMedia) {
        slides.push(createMediaSlide(featuredMedia));
        usedMediaIds.add(featuredMedia.id);
      }
    }

    // 2. Add hero video (if exists and not already added)
    if (heroVideoUrl && !usedMediaIds.has('hero-video')) {
      const heroVideo = {
        id: 'hero-video',
        type: 'video',
        videoSrc: heroVideoUrl,
        mimeType: 'video/mp4',
        alt: 'Hero Video',
        poster: null
      };
      slides.push(createMediaSlide(heroVideo));
      usedMediaIds.add('hero-video');
    }

    // 3. Add remaining product media (images only; filter out other variant images)
    productMedia.forEach(media => {
      if (!usedMediaIds.has(media.id) && shouldIncludeMedia(media)) {
        slides.push(createMediaSlide(media));
        usedMediaIds.add(media.id);
      }
    });

    // 4. Add placeholder slides if no content
    if (slides.length === 0) {
      for (let i = 1; i <= 4; i++) {
        const slide = document.createElement('div');
        slide.className = `broen-hero__media-item-${sectionId}`;
        const placeholder = document.createElement('div');
        placeholder.className = `broen-hero__placeholder-${sectionId}`;
        placeholder.textContent = i;
        slide.appendChild(placeholder);
        slides.push(slide);
      }
    }

    // Add all slides to carousel
    slides.forEach(slide => carousel.appendChild(slide));

    totalSlides = slides.length;
    currentSlide = 0;

    setupCarouselNavigation();
    if (carouselWrapper) {
      carouselWrapper.classList.toggle('single-slide', totalSlides < 2);
    }
    manageVideoPlayback();
  }

  function setupCarouselNavigation() {
    if (!carousel || !dotsContainer) return;
    
    console.log(`Setting up carousel with ${totalSlides} slides`);
    
    // Hide navigation if less than 2 slides
    if (totalSlides < 2) {
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
      if (dotsContainer) dotsContainer.style.display = 'none';
      return;
    }
    
    // Show navigation
    if (prevBtn) prevBtn.style.display = 'flex';
    if (nextBtn) nextBtn.style.display = 'flex';
    if (dotsContainer) dotsContainer.style.display = 'flex';
    
    // Create dots
    dotsContainer.innerHTML = '';
    for (let i = 0; i < totalSlides; i++) {
      const dot = document.createElement('button');
      dot.className = `broen-hero__dot-${sectionId}`;
      dot.setAttribute('aria-label', `Go to slide ${i + 1} of ${totalSlides}`);
      if (i === 0) dot.classList.add('active');
      dot.onclick = () => goToSlide(i);
      dotsContainer.appendChild(dot);
    }
  }
  
  function goToSlide(index) {
    if (index < 0) index = totalSlides - 1;
    if (index >= totalSlides) index = 0;
    
    currentSlide = index;
    console.log(`Going to slide ${index}`);
    
    const items = carousel.querySelectorAll(`.broen-hero__media-item-${sectionId}`);
    if (items[index]) {
      carousel.scrollTo({
        left: items[index].offsetLeft,
        behavior: 'smooth'
      });
      
      // Update dots
      document.querySelectorAll(`.broen-hero__dot-${sectionId}`).forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });

      // Manage video playback based on active slide
      manageVideoPlayback();
    }
  }

  function findVariant(colorValue, mortiseValue) {
    return variants.find(variant => {
      const colorMatch = colorOptionIndex === null || variant.options[colorOptionIndex] === colorValue;
      const mortiseMatch = mortiseOptionIndex === null || variant.options[mortiseOptionIndex] === mortiseValue;
      return colorMatch && mortiseMatch;
    });
  }

  function updateVariantSelection(newVariant) {
    if (!newVariant) return;

    currentVariant = newVariant;

    // Update form inputs
    if (variantIdInput) {
      variantIdInput.value = newVariant.id;
    }

    // Update price
    if (priceElement) {
      const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      });
      priceElement.textContent = formatter.format(newVariant.price / 100);
    }

    // Update buttons
    if (addToCartButton) {
      if (newVariant.available) {
        addToCartButton.disabled = false;
        addToCartButton.textContent = 'Add to Cart';
      } else {
        addToCartButton.disabled = true;
        addToCartButton.textContent = 'Sold Out';
      }
    }

    if (buyNowButton) {
      if (newVariant.available) {
        buyNowButton.disabled = false;
        buyNowButton.textContent = 'Buy Now';
      } else {
        buyNowButton.disabled = true;
        buyNowButton.textContent = 'Sold Out';
      }
    }

    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('variant', newVariant.id);
    history.replaceState(null, '', url);

    // Rebuild carousel with new variant's featured media first
    rebuildCarousel();

    // FIXED: Guard the event dispatch to prevent crashes
    if (section) {
      try {
        section.dispatchEvent(new CustomEvent('variant:change', {
          detail: { variant: newVariant }
        }));
      } catch (error) {
        console.log('Event dispatch failed:', error);
      }
    }
  }

  function initColorSelection() {
    const colorContainer = document.querySelector(`.broen-hero__colors-${sectionId}`);
    if (!colorContainer) return;

    // Set initial selection based on current variant
    const colorButtons = colorContainer.querySelectorAll(`.broen-hero__color-${sectionId}`);
    console.log(`Found ${colorButtons.length} color buttons`);
    
    colorButtons.forEach((btn, index) => {
      const colorValue = btn.dataset.colorValue;
      console.log(`Setting up color button ${index}: ${colorValue}`);
      
      if (colorValue === selectedColor) {
        btn.classList.add('selected');
        btn.setAttribute('aria-checked', 'true');
      } else {
        btn.classList.remove('selected');
        btn.setAttribute('aria-checked', 'false');
      }
    });
    
    // Use event delegation on the container instead of individual button listeners
    colorContainer.addEventListener('click', function(e) {
      // Find the color button that was clicked
      const colorBtn = e.target.closest(`.broen-hero__color-${sectionId}`);
      if (!colorBtn) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Color container click detected for:', colorBtn.dataset.colorValue);
      
      if (colorBtn.getAttribute('aria-disabled') === 'true' || colorBtn.disabled) {
        console.log('Color button is disabled, ignoring click');
        return;
      }
      
      const clickedColor = colorBtn.dataset.colorValue;
      console.log('Color clicked:', clickedColor);
      
      // Update selection
      const allColorButtons = colorContainer.querySelectorAll(`.broen-hero__color-${sectionId}`);
      allColorButtons.forEach(b => {
        b.classList.remove('selected');
        b.setAttribute('aria-checked', 'false');
      });
      
      colorBtn.classList.add('selected');
      colorBtn.setAttribute('aria-checked', 'true');
      
      selectedColor = clickedColor;
      console.log('Selected color updated to:', selectedColor);

      // Find and update variant
      const newVariant = findVariant(selectedColor, selectedMortise);
      if (newVariant) {
        console.log('Found variant:', newVariant.id);
        updateVariantSelection(newVariant);
        console.log('Variant updated successfully');
      } else {
        console.log('No variant found for:', selectedColor, selectedMortise);
      }
    });

    // Keyboard navigation for the container
    colorContainer.addEventListener('keydown', function(e) {
      const colors = Array.from(colorContainer.querySelectorAll(`.broen-hero__color-${sectionId}:not([aria-disabled="true"]):not(:disabled)`));
      const currentIndex = colors.indexOf(e.target);
      
      let newIndex = currentIndex;
      
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        newIndex = currentIndex > 0 ? currentIndex - 1 : colors.length - 1;
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        newIndex = currentIndex < colors.length - 1 ? currentIndex + 1 : 0;
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.target.click();
        return;
      }
      
      if (colors[newIndex]) {
        colors[newIndex].focus();
      }
    });
  }

  function initMortiseSelection() {
    const mortiseContainer = document.querySelector(`.broen-hero__mortise-grid-${sectionId}`);
    if (!mortiseContainer) return;

    // Set initial selection based on current variant
    const mortiseButtons = mortiseContainer.querySelectorAll(`.broen-hero__mortise-${sectionId}`);
    mortiseButtons.forEach(btn => {
      const mortiseValue = btn.dataset.mortiseValue;
      if (mortiseValue === selectedMortise) {
        btn.classList.add('selected');
        btn.setAttribute('aria-checked', 'true');
      } else {
        btn.classList.remove('selected');
        btn.setAttribute('aria-checked', 'false');
      }
    });

    // Handle mortise selection
    mortiseContainer.addEventListener('click', function(e) {
      // Find the mortise button even if clicked on image or text inside
      const mortiseBtn = e.target.closest(`.broen-hero__mortise-${sectionId}`);
      if (!mortiseBtn || mortiseBtn.getAttribute('aria-disabled') === 'true' || mortiseBtn.disabled) return;

      e.preventDefault();
      e.stopPropagation();

      // Update selection
      mortiseContainer.querySelectorAll(`.broen-hero__mortise-${sectionId}`).forEach(btn => {
        btn.classList.remove('selected');
        btn.setAttribute('aria-checked', 'false');
      });
      
      mortiseBtn.classList.add('selected');
      mortiseBtn.setAttribute('aria-checked', 'true');
      
      selectedMortise = mortiseBtn.dataset.mortiseValue;
      console.log('Selected mortise:', selectedMortise);

      // Find and update variant
      const newVariant = findVariant(selectedColor, selectedMortise);
      if (newVariant) {
        console.log('Found variant:', newVariant.id);
        updateVariantSelection(newVariant);
        console.log('Variant updated successfully');
      } else {
        console.log('No variant found for:', selectedColor, selectedMortise);
      }
    });

    // Keyboard navigation
    mortiseContainer.addEventListener('keydown', function(e) {
      const mortises = Array.from(mortiseContainer.querySelectorAll(`.broen-hero__mortise-${sectionId}:not([aria-disabled="true"]):not(:disabled)`));
      const currentIndex = mortises.indexOf(e.target);
      
      let newIndex = currentIndex;
      
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        newIndex = currentIndex > 0 ? currentIndex - 1 : mortises.length - 1;
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        newIndex = currentIndex < mortises.length - 1 ? currentIndex + 1 : 0;
      } else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.target.click();
        return;
      }
      
      if (mortises[newIndex]) {
        mortises[newIndex].focus();
      }
    });
  }

  function initCarouselControls() {
    // Navigation buttons
    if (prevBtn) {
      prevBtn.onclick = (e) => {
        e.preventDefault();
        goToSlide(currentSlide - 1);
      };
    }
    
    if (nextBtn) {
      nextBtn.onclick = (e) => {
        e.preventDefault();
        goToSlide(currentSlide + 1);
      };
    }
    
    // Update active dot on manual scroll
    if (carousel) {
      carousel.addEventListener('scroll', () => {
        const items = carousel.querySelectorAll(`.broen-hero__media-item-${sectionId}`);
        if (items.length === 0) return;
        
        const itemWidth = items[0].offsetWidth;
        const newIndex = Math.round(carousel.scrollLeft / itemWidth);
        
        if (newIndex !== currentSlide && newIndex >= 0 && newIndex < totalSlides) {
          currentSlide = newIndex;
          document.querySelectorAll(`.broen-hero__dot-${sectionId}`).forEach((dot, i) => {
            dot.classList.toggle('active', i === currentSlide);
          });
          // Ensure correct video playback when user scrolls manually
          manageVideoPlayback();
        }
      }, { passive: true });
      
      // Touch/swipe support
      let startX = 0;
      let isDragging = false;
      
      carousel.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      }, { passive: true });
      
      carousel.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;
        
        const endX = e.changedTouches[0].clientX;
        const diffX = startX - endX;
        
        if (Math.abs(diffX) > 50) { // Minimum swipe distance
          if (diffX > 0) {
            goToSlide(currentSlide + 1); // Swipe left - next slide
          } else {
            goToSlide(currentSlide - 1); // Swipe right - prev slide
          }
        }
      }, { passive: true });
      
      // Keyboard navigation
      carousel.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          goToSlide(currentSlide - 1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          goToSlide(currentSlide + 1);
        }
      });
    }
  }

  function manageVideoPlayback() {
    if (!carousel) return;
    const items = carousel.querySelectorAll(`.broen-hero__media-item-${sectionId}`);
    items.forEach((item, idx) => {
      const video = item.querySelector(`video.broen-hero__media-content-${sectionId}`);
      if (!video) return;
      if (idx === currentSlide) {
        try { video.play().catch(() => {}); } catch (e) {}
      } else {
        try { video.pause(); video.currentTime = 0; } catch (e) {}
      }
    });
  }

  function initButtons() {
    const form = document.getElementById(`product-form-${sectionId}`);
    
    // Add to Cart functionality
    if (form && addToCartButton) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const originalText = addToCartButton.textContent;
        
        addToCartButton.textContent = 'Adding...';
        addToCartButton.disabled = true;
        
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          addToCartButton.textContent = 'Added!';
          
          // Trigger cart drawer or notification here if needed
          document.dispatchEvent(new CustomEvent('cart:item-added', {
            detail: { variant: data }
          }));
          
          setTimeout(() => {
            addToCartButton.textContent = originalText;
            addToCartButton.disabled = false;
          }, 2000);
        })
        .catch(error => {
          console.error('Error:', error);
          addToCartButton.textContent = 'Error - Try again';
          addToCartButton.disabled = false;
          
          setTimeout(() => {
            addToCartButton.textContent = originalText;
          }, 2000);
        });
      });
    }

    // Buy Now functionality
    if (buyNowButton) {
      buyNowButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!currentVariant || !currentVariant.available) return;
        
        const originalText = this.textContent;
        this.textContent = 'Processing...';
        this.disabled = true;
        
        // Create form data for the current variant
        const formData = new FormData();
        formData.append('id', currentVariant.id);
        formData.append('quantity', '1');
        
        // Add to cart first, then redirect to checkout
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // Redirect to checkout
          window.location.href = '/checkout';
        })
        .catch(error => {
          console.error('Error:', error);
          this.textContent = 'Error - Try again';
          
          setTimeout(() => {
            this.textContent = originalText;
            this.disabled = false;
          }, 2000);
        });
      });
    }
  }

  // Initialize everything
  function init() {
    console.log('Initializing Broen Product Page with section ID:', sectionId);
    console.log('Current variant:', currentVariant);
    console.log('Color option index:', colorOptionIndex);
    console.log('Mortise option index:', mortiseOptionIndex);
    console.log('Selected color:', selectedColor);
    console.log('Selected mortise:', selectedMortise);
    
    initializeFromURL();
    rebuildCarousel();
    initColorSelection();
    initMortiseSelection();
    initCarouselControls();
    initButtons();
    manageVideoPlayback();
    
    // Debug: Check if buttons exist
    const colorButtons = document.querySelectorAll(`.broen-hero__color-${sectionId}`);
    const mortiseButtons = document.querySelectorAll(`.broen-hero__mortise-${sectionId}`);
    console.log('Found color buttons:', colorButtons.length);
    console.log('Found mortise buttons:', mortiseButtons.length);
    
    console.log('Initialization complete - all functionality ready');
  }

  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

{% schema %}
{
  "name": "Broen Product Page",
  "settings": [
    {
      "type": "header",
      "content": "Core Colors"
    },
    {
      "type": "color",
      "id": "page_background",
      "label": "Page background",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card background",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "media_background",
      "label": "Media background",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Primary text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "muted_text_color",
      "label": "Muted text",
      "default": "#999999"
    },
    {
      "type": "color",
      "id": "classification_text_color",
      "label": "Classification pill text",
      "default": "#deb887"
    },
    {
      "type": "color",
      "id": "classification_background",
      "label": "Classification pill background",
      "default": "rgba(97,69,36,0.4)"
    },
    {
      "type": "color",
      "id": "classification_border",
      "label": "Classification pill border",
      "default": "rgba(97,69,36,0.6)"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "rgba(255, 255, 255, 0.1)"
    },
    {
      "type": "header",
      "content": "Interactive Elements"
    },
    {
      "type": "color",
      "id": "chip_background",
      "label": "Chip background",
      "default": "#222222"
    },
    {
      "type": "color",
      "id": "chip_text_color",
      "label": "Chip text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "focus_color",
      "label": "Focus outline",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Active carousel dot",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dot_inactive_color",
      "label": "Inactive carousel dot",
      "default": "rgba(255, 255, 255, 0.3)"
    },
    {
      "type": "header",
      "content": "Mortise Appearance"
    },
    {
      "type": "color",
      "id": "mortise_chip_background",
      "label": "Mortise chip background",
      "default": "#222222"
    },
    {
      "type": "color",
      "id": "mortise_chip_text_color",
      "label": "Mortise chip text",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Buy Now Button"
    },
    {
      "type": "color",
      "id": "buy_now_background",
      "label": "Buy Now background",
      "default": "#007AFF"
    },
    {
      "type": "color",
      "id": "buy_now_text_color",
      "label": "Buy Now text",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "buy_now_hover_background",
      "label": "Buy Now hover background",
      "default": "#0056CC"
    },
    {
      "type": "header",
      "content": "Call-to-Action"
    },
    {
      "type": "color",
      "id": "cta_background",
      "label": "Add to cart background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "cta_text_color",
      "label": "Add to cart text",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "cta_hover_background",
      "label": "Add to cart hover",
      "default": "#f0f0f0"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border radius",
      "min": 8,
      "max": 32,
      "step": 2,
      "default": 20,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "Broen Product Page"
    }
  ]
}
{% endschema %}